import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.neighbors import KNeighborsClassifier
from sklearn.metrics import classification_report, confusion_matrix, accuracy_score
import matplotlib.pyplot as plt
df_features = df.drop(columns=['Provinsi', 'Kab/Kota', 'Klasifikasi Kemiskinan'])

for col in df_features.columns:
    df_features[col] = (
        df_features[col]
        .astype(str)
        .str.replace(',', '.', regex=False)
        .astype(float)
    )

X = df_features.values
y = df['Klasifikasi Kemiskinan']

y = y.astype(str).str.strip()
y = y.str.replace(',', '.', regex=False)
y = pd.to_numeric(y, errors='coerce')

mask = y.notna()
X = X[mask]
y = y[mask].astype(int)

print(np.unique(y))
X_train, X_test, y_train, y_test = train_test_split(
    X, y,
    test_size=0.2,
    random_state=42,
    stratify=y
)

print("Train:", X_train.shape)
print("Test:", X_test.shape)
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)
classifier = KNeighborsClassifier(n_neighbors=5)
classifier.fit(X_train_scaled, y_train)

print("Model KNN berhasil dilatih")
y_pred = classifier.predict(X_test_scaled)

print("Akurasi:", accuracy_score(y_test, y_pred))
cm = confusion_matrix(y_test, y_pred)
print("Confusion Matrix:")
print(cm)
print("Classification Report:")
print(classification_report(
    y_test,
    y_pred,
    target_names=["Tidak Miskin", "Miskin"]
))
data_baru = np.array([[
    15.5, 8.5, 8500, 68.5, 67.0,
    75.0, 80.0, 5.0, 70.0, 5000000
]])

data_baru_scaled = scaler.transform(data_baru)
prediksi = classifier.predict(data_baru_scaled)

print("Hasil Prediksi:", 
      "MISKIN" if prediksi[0] == 1 else "TIDAK MISKIN")
print("KESIMPULAN:")
print("1. Model KNN berhasil digunakan untuk klasifikasi kemiskinan.")
print("2. Data dibagi 80% latih dan 20% uji menggunakan stratified sampling.")
print("3. Model mampu mengklasifikasikan daerah miskin dan tidak miskin.")
print("4. Sistem dapat menerima data baru dan memberikan prediksi.")
